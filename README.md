# ROS_ablation-smlt-
creating enrgy flux files 
Bulk Energy Flux Processing (ROS vs. nROS)OverviewThis script calculates the mean energy flux components (Sensible Heat, Latent Heat, Net Solar, Net Thermal) specifically during Rain-on-Snow (ROS) and Non-Rain-on-Snow (nROS) melt events.It bridges two distinct datasets to create a climatology of melt drivers:Event Data: Custom NetCDF files defining when and where snowmelt events occurred (snowmelt_events_YYYY.nc).Forcing Data: Raw ERA5-Land energy flux files (accumulated $J/m^2$).The output is a set of yearly NetCDF files containing spatial maps of the average energy drivers ($W/m^2$) for these specific events.DependenciesPython 3.xxarraynumpynetCDF4 (backend for xarray)dask (optional, for parallel loading)ConfigurationUpdate the User Configuration section at the top of the script before running:Python# Years to process
YEARS = range(2017, 2020)

# Input Directories
EVENT_DIR = '/path/to/snowmelt_events/'  # Contains snowmelt_events_YYYY.nc
FLUX_DIR  = '/path/to/raw_era5_fluxes/'  # Contains ERA5_sshf_YYYY.nc, etc.

# Output Directory
OUTPUT_DIR = '/path/to/output/'
Methodology & AlgorithmThe script processes data in the following sequential steps:1. Data LoadingIterates through the specified years.Loads the binary/masked event file (ros_melt_amount, nros_melt_amount).Loads the four raw ERA5-Land flux variables:sshf (Sensible Heat Flux)slhf (Latent Heat Flux)ssr (Net Shortwave / Solar)str (Net Longwave / Thermal)2. De-accumulation (Physics Correction)ERA5-Land flux data is stored as accumulated energy ($J/m^2$) resetting at 00:00 UTC daily. To obtain physical fluxes ($W/m^2$), the script performs temporal differencing:Differencing: Calculates $\Delta E = E(t) - E(t-1)$.Reset Handling (03:00 UTC):At 03:00 UTC, the raw value represents the accumulation from 00:00 to 03:00.Subtracting the 00:00 value (which is the previous day's 24-hour total) would result in a massive negative error.Logic: If hour == 3, the script uses the raw value instead of the difference.Solar Correction: Clamps tiny negative values in Shortwave Radiation (ssr) to 0 (noise reduction).3. Alignment & Unit ConversionTemporal Alignment: The differencing step drops the first time step (Jan 1, 00:00) because there is no previous value to subtract. The script calculates the intersection of valid timestamps between Flux and Event data to ensure 1-to-1 matching.Unit Conversion:Input: Accumulated Energy ($J/m^2$) per 3-hour interval.Calculation:$$Power (W/m^2) = \frac{\text{Energy} (J/m^2)}{3 \times 3600 \text{ seconds}}$$4. Event Masking & AveragingThe script isolates specific event hours rather than averaging the entire year.Merging: Fluxes and Event data are merged into a single dataset.Masking:ROS Mask: ros_melt_amount > -9999nROS Mask: nros_melt_amount > -9999Conditional Averaging:Computes the mean flux only where the mask is True.Result: A single spatial map per variable representing the "Average Flux Intensity" during ROS/nROS events.Key Technical DecisionsWhy reset at 03:00?The raw data accumulation resets at 00:00 UTC.00:00 Value: Total accumulation of the previous day (huge).03:00 Value: First accumulation of the current day (small).Action: At 03:00, we must not subtract the 00:00 value. We use the raw 03:00 value directly.Why do we lose one time step?Differentiation (diff) inherently reduces the array size by 1. We sacrifice the first hour of the year (Jan 1, 00:00) to ensure the physics ($W/m^2$ conversion) is accurate for the remaining ~8,760 hours.Output VariablesThe resulting NetCDF files (mean_flux_components_YYYY_direct.nc) contain 8 variables:Variable NameDescriptionUnitsmean_ros_sensibleAvg. Sensible Heat during ROS events$W/m^2$mean_ros_latentAvg. Latent Heat during ROS events$W/m^2$mean_ros_solarAvg. Net Solar Radiation during ROS events$W/m^2$mean_ros_thermalAvg. Net Thermal Radiation during ROS events$W/m^2$mean_nros_...(Same 4 variables for Non-ROS melt)$W/m^2$
